name: Staging DAG Deployment
on:
  push:
    branches:
      - staging

jobs:
  dag_deployment:
    name: DAG Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Code Checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.G_TOKEN }}
         
      - name: DAG image creation and airflow deployment
        uses: elgohr/Publish-Docker-Github-Action@master
        with:
          name: ${{ secrets.STG_RELEASE_NAME }}/airflow:deploy-ci-${{ github.run_number }}
          username: _
          password: ${{ secrets.SA_PASS_KEY }}
          registry: registry.astronomer.condenast.io
          
  branch_creation:
    runs-on: ubuntu-latest
    environment: 'prod-branch-creation'
    needs: dag_deployment
    steps:
      - name: Code Checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.G_TOKEN }}
          fetch-depth: 0

      - name: Tag Versioning
        id: tag_creation
        run: |
          version_increament=0.1
          current_tag=`git tag --sort version:refname | tail -n1`
          version_tag=$(echo "$current_tag + $version_increament" | bc)
          echo $version_tag > ./version_tag.txt
          date
          cat ./version_tag.txt
          echo "::set-output name=TAG_NAME::$(cat ./version_tag.txt)"
          ls -l

      - name: tagging
        uses: rickstaa/action-create-tag@v1
        with:
          tag: ${{ steps.tag_creation.outputs.TAG_NAME }}
          message: "latest tag created"

      - name: create production branch
        uses: peterjgrainger/action-create-branch@v2.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.G_TOKEN }}
        with:
          branch: 'production'
